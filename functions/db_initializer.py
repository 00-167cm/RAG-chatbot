"""
Cloud Functionsç”¨ - ãƒ‡ãƒ¢ãƒãƒ£ãƒƒãƒˆãƒªã‚»ãƒƒãƒˆå‡¦ç†

æ¯æ—¥22æ™‚ã«Cloud Schedulerã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã€
Firestoreã®ãƒãƒ£ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¼šè©±ã‚’ä½œæˆã™ã‚‹
"""
import functions_framework
from firebase_admin import credentials, firestore, initialize_app
from datetime import datetime, timezone, timedelta
import os

# æ—¥æœ¬æ¨™æº–æ™‚ï¼ˆJSTï¼‰
JST = timezone(timedelta(hours=9))

# FirebaseåˆæœŸåŒ–ï¼ˆCloud Functionsç’°å¢ƒã§ã¯è‡ªå‹•ã§èªè¨¼ã•ã‚Œã‚‹ï¼‰
# æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
try:
    initialize_app()
except ValueError:
    pass  # æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿

db = firestore.client()

# ============================================
# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¼šè©±ã®å®šç¾©
# ============================================
TEMPLATE_CHATS = [
    {
        "title": "å¯©æŸ»ã®æµã‚Œã«ã¤ã„ã¦",
        "messages": [
            {
                "role": "user",
                "content": "å¯©æŸ»ã®æµã‚Œã‚’æ•™ãˆã¦",
            },
            {
                "role": "assistant",
                "content": """NSCæ¥­å‹™ãƒ•ãƒ­ãƒ¼ã«åŸºã¥ãã€å¯©æŸ»ã®æµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. **åˆæœŸå—ä»˜**: ç”³è¾¼ãƒ‡ãƒ¼ã‚¿ã«å¿…ãšã€ŒNSCã‚³ãƒ¼ãƒ‰ã€ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šæ¡ˆä»¶ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

2. **æ›¸é¡å—é ˜ãƒ»ç¢ºèª**: æ›¸é¡ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€ä¸å‚™ãŒã‚ã‚‹å ´åˆã¯ã€ŒNSC-NGç†ç”±ã‚³ãƒ¼ãƒ‰è¡¨ã€ã«åŸºã¥ãã€å…·ä½“çš„ãªä¸å‚™å†…å®¹ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²ã—ã¾ã™ã€‚

3. **ä¿¡ç”¨æƒ…å ±ç…§ä¼š**: CICãƒ»JICCãƒ»å…¨éŠ€å”ã®3æ©Ÿé–¢ã™ã¹ã¦ã‚’å¿…ãšç…§ä¼šã—ã€ã€ŒNSCå¯©æŸ»ã‚·ãƒ¼ãƒˆã€ã«è¨˜éŒ²ã—ã¾ã™ã€‚

4. **å¯©æŸ»åˆ¤å®š**: ã€ŒNSCå¯©æŸ»åŸºæº–ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã€ã«å¾“ã„ã€ã‚°ãƒ¬ãƒ¼ã‚¾ãƒ¼ãƒ³æ¡ˆä»¶ã¯å¿…ãšã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ï¼ˆSVï¼‰ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚

5. **å¥‘ç´„å†…å®¹ç¢ºå®š**: ã€ŒNSCæ‰¿èªãƒ¬ãƒ™ãƒ«è¡¨ã€ã«åŸºã¥ãã€é‡‘é¡ã«å¿œã˜ãŸæ‰¿èªè€…ã®é›»å­æ‰¿èªã‚’å–å¾—ã—ã¾ã™ã€‚

6. **æœ€çµ‚æ±ºè£ä¾é ¼**: ã€ŒNSCæ±ºè£ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ã‚’ä½¿ç”¨ã—ã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå…¨é …ç›®ã‚’ç¢ºèªæ¸ˆã¿ã«ã—ã¾ã™ã€‚

è©³ã—ã„æ‰‹ç¶šãã‚„æ³¨æ„ç‚¹ã«ã¤ã„ã¦ã¯ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã«ãŠã‘ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦é€²ã‚ã¦ãã ã•ã„ã€‚""",
                "is_rag": True,
                "chunks": [
                    {
                        "chunk_id": "acom_workflow_rag.pdf_4_3",
                        "distance": 1.0134,
                        "source": "acom_workflow_rag.pdf"
                    },
                    {
                        "chunk_id": "acom_workflow_rag.pdf_2_1",
                        "distance": 1.1445,
                        "source": "acom_workflow_rag.pdf"
                    },
                    {
                        "chunk_id": "acom_workflow_rag.pdf_5_4",
                        "distance": 1.1711,
                        "source": "acom_workflow_rag.pdf"
                    }
                ]
            }
        ]
    },
    {
        "title": "çŠ¬ã®ç¨®é¡ä¸€è¦§",
        "messages": [
            {
                "role": "user",
                "content": "çŠ¬ã®ç¨®é¡ã‚’ä¸€è¦§ã§è¦‹ã›ã¦ï¼",
            },
            {
                "role": "assistant",
                "content": """äººæ°—ã®çŠ¬ç¨®ã‚’ä¸€è¦§ã§ã”ç´¹ä»‹ã—ã¾ã™ï¼ğŸ•

## å°å‹çŠ¬

| çŠ¬ç¨® | ç‰¹å¾´ | ä½“é‡ç›®å®‰ |
|------|------|----------|
| ãƒˆã‚¤ãƒ—ãƒ¼ãƒ‰ãƒ« | è³¢ãã¦æŠœã‘æ¯›ãŒå°‘ãªã„ | 3-4kg |
| ãƒãƒ¯ãƒ¯ | ä¸–ç•Œæœ€å°ã®çŠ¬ç¨® | 1-3kg |
| ãƒãƒ¡ãƒ©ãƒ‹ã‚¢ãƒ³ | ãµã‚ãµã‚ã®æ¯›ä¸¦ã¿ | 2-3kg |
| ãƒŸãƒ‹ãƒãƒ¥ã‚¢ãƒ€ãƒƒã‚¯ã‚¹ | èƒ´é•·çŸ­è¶³ãŒå¯æ„›ã„ | 4-5kg |

## ä¸­å‹çŠ¬

| çŠ¬ç¨® | ç‰¹å¾´ | ä½“é‡ç›®å®‰ |
|------|------|----------|
| æŸ´çŠ¬ | æ—¥æœ¬ã‚’ä»£è¡¨ã™ã‚‹çŠ¬ç¨® | 8-10kg |
| ã‚³ãƒ¼ã‚®ãƒ¼ | çŸ­ã„è¶³ã¨å¤§ããªè€³ | 10-12kg |
| ãƒ“ãƒ¼ã‚°ãƒ« | å„ªã‚ŒãŸå—…è¦šã‚’æŒã¤ | 9-11kg |

## å¤§å‹çŠ¬

| çŠ¬ç¨® | ç‰¹å¾´ | ä½“é‡ç›®å®‰ |
|------|------|----------|
| ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ¬ãƒˆãƒªãƒãƒ¼ | å„ªã—ãå¾“é † | 25-35kg |
| ãƒ©ãƒ–ãƒ©ãƒ‰ãƒ¼ãƒ«ãƒ¬ãƒˆãƒªãƒãƒ¼ | ç›²å°çŠ¬ã¨ã—ã¦ã‚‚æ´»èº | 25-35kg |
| ã‚·ãƒ™ãƒªã‚¢ãƒ³ãƒã‚¹ã‚­ãƒ¼ | é’ã„ç›®ãŒç¾ã—ã„ | 20-30kg |

æ°—ã«ãªã‚‹çŠ¬ç¨®ã¯ã‚ã‚Šã¾ã™ã‹ï¼ŸğŸ¶""",
                "is_rag": False,
                "chunks": []
            }
        ]
    }
]


@functions_framework.http
def reset_chats(request):
    """
    HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒªã‚»ãƒƒãƒˆé–¢æ•°
    
    Cloud Schedulerã‹ã‚‰æ¯æ—¥22æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹
    1. Firestoreã®å…¨ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤
    2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¼šè©±ã‚’æ–°è¦ä½œæˆ
    """
    now = datetime.now(JST)
    print(f"ğŸ”„ ãƒªã‚»ãƒƒãƒˆé–‹å§‹: {now.strftime('%Y-%m-%d %H:%M:%S')}")
    
    try:
        chats_ref = db.collection('chats')
        
        # ============================================
        # Step 1: å…¨ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤
        # ============================================
        docs = chats_ref.get()
        delete_count = 0
        
        for doc in docs:
            doc.reference.delete()
            delete_count += 1
            print(f"   âœ… å‰Šé™¤: {doc.id}")
        
        print(f"ğŸ“‹ {delete_count}ä»¶ã®ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
        
        # ============================================
        # Step 2: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¼šè©±ã‚’ä½œæˆ
        # ============================================
        create_count = 0
        
        for template in TEMPLATE_CHATS:
            chat_data = {
                "title": template["title"],
                "messages": template["messages"],
                "created_at": now,
                "updated_at": now
            }
            
            doc_ref = chats_ref.add(chat_data)
            create_count += 1
            print(f"   âœ… ä½œæˆ: {template['title']}")
        
        print(f"ğŸ“ {create_count}ä»¶ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ")
        
        # ============================================
        # å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        # ============================================
        result_message = f"""
âœ… ãƒ‡ãƒ¢ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼
å®Ÿè¡Œæ—¥æ™‚: {now.strftime('%Y-%m-%d %H:%M:%S')} (JST)
å‰Šé™¤æ•°: {delete_count}ä»¶
ä½œæˆæ•°: {create_count}ä»¶
        """.strip()
        
        print(result_message)
        return result_message, 200
        
    except Exception as e:
        error_message = f"âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {str(e)}"
        print(error_message)
        return error_message, 500